#!/bin/bash

################################################################################
# This file makes grepping faster and a little less frustrating with our       #
# horrible symlinking stupidness                                               #
#                                                                              #
# Suggested usage:                                                             #
# In your .bashrc add the following:                                           #
# alias g="bash <location of script>/grep_r.sh"                                #
#                                                                              #
#                                                                              #
#                                                                              #
# Usage:                                                                       #
# fast_grep [-i][ -d][ -s][ -c][ -n][ -f <folder|file>] <search_term>          #
#                                                                              #
# Arguments:                                                                   #
#    -i : Case insensitive, this is much slower                                #
#    -d : Remove duplicate files, this takes longer, and you only get output   #
#       :  once it is complete.                                                #
#    -s : Leave the .svn files in the results                                  #
#    -c : show content of the line found, this does not play nice with [-d]    #
#    -n : Show line numbers, this does not play nice with [-d] or [-c]         #
#    -f <folder|file> : The folder to search in                                #
#    -j <number of jobs> : The amount of jobs to run                           #
#    -nh : print no help text                                                  #
#    -cmd : Print the command to be run                                        #
#    -q : Never use threads                                                    #
################################################################################

SEARCH="."
LOCATION="."
CASEINSENSITIVE=0
DEDUP=0
FILTERSVN=1
SHOWCONTENT="l"
LINENUMBER=""
JOBS=4
HELP=1
SINGLE=0
CMD=0
while [ $# -gt 0 ]
do
    opt=$1
    shift
    case ${opt} in
        -i)
            CASEINSENSITIVE=1
            ;;
        -d)
            DEDUP=1
            SINGLE=1
            ;;
        -s)
            FILTERSVN=0
            ;;
        -c)
            SHOWCONTENT=""
            ;;
        -n)
            LINENUMBER="n"
            ;;
        -f)
            if [ $# -eq 0 ]; then
                Die "The ${opt} option requires an argument."
            fi
            LOCATION="$1"
            shift
            ;;
        -j)
            if [ $# -eq 0 ]; then
                Die "The ${opt} option requires an argument."
            fi
            JOBS="$1"
            shift
            ;;
        -nh)
            HELP=0
            ;;
        -cmd)
            CMD=1
            ;;
        -q)
            SINGLE=1
            ;;
        *)
            SEARCH="$opt"
            ;;
    esac
done

GREPCOMMAND="grep -rs"
if [ $CASEINSENSITIVE -eq 1 ]; then
    GREPCOMMAND="grep --color=auto -rsi"
fi
if [ -d $LOCATION ] && [ $SINGLE -eq 0 ] ; then
    COMMAND="for i in \$(ls $LOCATION); do while [ \$(jobs -l | wc -l) -ge $JOBS ]; do sleep 1; done; $GREPCOMMAND$SHOWCONTENT$LINENUMBER \"$SEARCH\" \"$LOCATION/\$i\" & done"
else
    COMMAND="$GREPCOMMAND$SHOWCONTENT$LINENUMBER \"$SEARCH\" \"$LOCATION\""
fi


if [ $FILTERSVN -eq 1 ]; then
    COMMAND="$COMMAND | grep -v \"svn\""
fi
if [ $HELP -eq 1 ]; then
    echo "GREP [$SEARCH] in [$LOCATION] <CI:$CASEINSENSITIVE|FS:$FILTERSVN|DEDUP:$DEDUP|JS:$JOBS/$SINGLE|CN:$SHOWCONTENT>"
fi
if [ $CMD -eq 1 ]; then
    echo "$COMMAND"
fi
if [ $DEDUP -eq 1 ]; then
    eval $COMMAND | while read a; do \
        while [ $(jobs -l | wc -l) -ge 10 ]; do sleep 1; done; \
        find -L "$LOCATION" -samefile "$a" | head -n 1 & \
    done | sort -u
else
    eval $COMMAND
fi

